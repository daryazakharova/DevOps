## Part 1. Настройка gitlab-runner  
- Поднимем виртуальную машину Ubuntu Server 22.04 LTS  
![Ubuntu](image/1.png) 
- Установка на виртуальную машину gitlab-runner   
    - Для его установки необходимо сначала настроить репозиторий:  
    `curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash`  
    ![Ubuntu](image/2.png)  
    - Установим пакет:  
    `sudo apt-get install gitlab-runner`  
    ![install](image/3.png)  
    ![gitlab-runner -v](image/4.png)  
- Запустить gitlab-runner и зарегистрировать его для использования в текущем проекте (DO6_CICD)  
`sudo gitlab-runner register`   
![register ](image/5.png)  

## Part 2. Сборка  
Напишем этап для CI по сборке приложений из проекта C2_SimpleBashUtils:
- В файле .gitlab-ci.yml добавлен этап запуска сборки через мейк файл из проекта C2_SimpleBashUtils. Файлы, полученные после сборки (артефакты), сохраняться в директорию /src/* со сроком хранения 30 дней.  
![gitlab-ci.yml ](image/6.png)  
    При первой сборке пайплайн «зафейлин», так как не хватало нужных пактов, после установки `sudo apt install gcc`, `sudo apt install make` сборка прошла успешно.
![gitlab-ci.yml ](image/6.1.png)  
![gitlab-ci.yml ](image/6.2.png)  

## Part 3. Тест кодстайла  
Напишем этап для CI, который запускает скрипт кодстайла (clang-format):  
- В файле .gitlab-ci.yml добавлен этап кодстайла:  
![gitlab-ci.yml ](image/7.png)  
- Тест кодстайла пройден успешно  
![gitlab-ci.yml ](image/7.1.png)  
![gitlab-ci.yml ](image/7.2.png)  
- Проверка на кодстайл, eсли не пройден, то пайплайн «зафейлин» и отображение вывода утилиты clang-format:  
![gitlab-ci.yml ](image/7.3.png)  
![gitlab-ci.yml ](image/7.4.png)  

## Part 4. Интеграционные тесты  
Напишем этап для CI, который запускает интеграционные тесты из проекта C2_SimpleBashUtils:  
- В файле .gitlab-ci.yml добавлен этап тестирования. Запускается этот этап автоматически при условии, если сборка и тест кодстайла прошли успешно.   
![gitlab-ci.yml ](image/8.png)  
![gitlab-ci.yml ](image/8.1.png)  
В пайплайне отображается вывод, что интеграционные тесты прошли успешно.  

## Part 5. Этап деплоя   
Настраиваем виртуальные машины:  
- Поднимаем вторую виртуальную машину и настриваем сеть на тип соединения `сетевой мост`, чтобы виртуальные машины находились в локальной сети.
- Запрашиваем новые ip адреса для машин и пингуем их, чтобы проверить соединение   
![deploy](image/9.png)   
- Переходим в юзера gitlab-runner `su gitlab-runner`  
- На нём генерируем ключ ssh `ssh-keygen`  
- Пробрасываем ключ серверу `ssh-copy-id daariopa@192.168.0.103`  
- Даём gitlab-runner прав sudo `usermod -aG sudo gitlab-runner`  
- На сервере(второй машине) даём права к директории /usr/local/bin `chmod +x /usr/local/bin`  

Допишем этап для CD, который «разворачивает» проект на другой виртуальной машине:  
- Прописываем bash-скрипт, который при помощи ssh и scp копирует файлы, полученные после сборки (артефакты), в директорию /usr/local/bin второй виртуальной машины  
![deploy](image/11.png)    
- в файле gitlab-ci.yml добавим этап запуска написанного скрипта. Этап запускается вручную `when` при условии, что все предыдущие этапы прошли успешно `needs`   
![deploy](image/10.png)  
- При успешном пайплайне этапа делпоя в гитлабе пайплайн будет отображаться следующим образом:  
![deploy](image/13.png)  
- В результате получаем готовые к работе приложения из проекта C2_SimpleBashUtils (s21_cat и s21_grep) на второй виртуальной машине  
![deploy](image/14.png)  

## Part 6. Дополнительно. Уведомления  
Настройка уведомления о успешном/неуспешном выполнении пайплайна через бота с именем «Daariopa DO6 CI/CD» в Telegram:   
- Создаем бота в Телеграм с помощью BotFather  
![telegram](image/15.png)  
- Создаем скрипт telegram.sh, со следующим содержанием  
![telegram](image/16.png)  
- Для получения id чата в браузере забиваем `https://api.telegram.org/bot<BOT_TOKEN>/getUpdates`, и отправляем любое сообщение в чат бота. На странице отобразятся данные, включая id чата в который отправили сообщение  
- Добавляем в файл gitlab-ci.yml зпуск скрипта после выполенения каждого этапа  
![telegram](image/17.png)  
- Текст уведомления содержит информацию об успешности прохождения как этапа CI, так и этапа CD  
![telegram](image/18.png)
  
